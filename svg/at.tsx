import { GestureWrapper } from "@/components/common/GestureWrapper";
import { useUserChoices } from "@/contexts/userChoicesProvider/UserChoicesContextProvider";
import { getMeasurementUnit } from "@/helpers/getMeasurementUnit";
import { MeasurementUnit } from "@/models/measurementUnit";
import React, { useEffect } from "react";
import { useTranslation } from "react-i18next";
import { Image, StyleSheet, Text, View } from "react-native";
import Animated, {
  useAnimatedProps,
  useSharedValue,
  withTiming,
} from "react-native-reanimated";
import Svg, { Path } from "react-native-svg";

export const StickerSmall: React.FC = () => {
  const {
    selectedHike,
    distanceHiked,
    selectedHikeTotalDistance,
    measurementUnit,
    showBorders,
  } = useUserChoices();

  const { t } = useTranslation();

  const AnimatedPath = Animated.createAnimatedComponent(Path);

  const calculatePercentage = () => {
    let newPercentage = 0;
    if (measurementUnit == MeasurementUnit.KILOMETER) {
      newPercentage = Math.round(
        (distanceHiked * 100) / selectedHike?.totalDistanceKilometer!
      );
    } else {
      newPercentage = Math.round(
        (distanceHiked * 100) / selectedHike?.totalDistanceMile!
      );
    }

    return newPercentage;
  };

  const progress = useSharedValue(0);

  const animatedProps = useAnimatedProps(() => {
    const length = selectedHike?.pathLength ?? 0;
    return {
      strokeDashoffset: length - progress.value,
    } as any;
  });

  useEffect(() => {
    if (!selectedHike?.pathLength) return;

    const ratio = Math.max(
      0,
      Math.min(1, distanceHiked / selectedHikeTotalDistance)
    );

    progress.value = 0;
    progress.value = withTiming(ratio * selectedHike.pathLength, {
      duration: 2000,
    });
  }, [distanceHiked, selectedHikeTotalDistance, selectedHike?.pathLength]);

  return (
    <GestureWrapper>
      <View style={styles.container}>
        <View style={styles.statsContainer}>
          <Image
            source={{ uri: selectedHike?.logo }}
            style={{ width: 40, height: 40 }}
          />
          <Text style={styles.percentage}>Appalachian Trail</Text>
          <Text style={styles.label}>{t("index:sticker.total")}</Text>
          <Text style={styles.value}>
            {selectedHikeTotalDistance} {getMeasurementUnit(measurementUnit)}
          </Text>
          <Text style={styles.label}>{t("index:sticker.distanceHiked")}</Text>
          <Text style={styles.value}>
            {distanceHiked} {getMeasurementUnit(measurementUnit)}
          </Text>
        </View>
        <Svg width={120} height={220} viewBox="0 0 711 767" fill="none">
          {showBorders && (
            <>
              <Path
                d={
                  "M386.247 336.576C393.659 337.724 397.736 336.558 404.722 331.404C430.87 316.673 459.734 305.169 456.082 298.898C454.234 294.669 453.234 292.669 451.234 287.669M362.599 309.979C371.513 311.729 377.276 313.371 389.203 317.737M362.599 309.979C350.965 307.781 343.949 302.629 330.453 285.6C274.537 298.933 242.921 306.145 183.764 316.259C179.855 314.825 180.23 311.056 180.808 304.439C171.43 314.319 166.613 317.962 158.639 321.8L167.506 379.425M362.599 309.979C342.839 338.468 346.262 348.483 369.989 359.108L349.667 381.272M389.203 317.737C383.74 338.184 386.056 341.802 393.637 343.225C396.439 370.791 395.054 382.675 385.508 395.309C381.845 408.703 379.812 414.243 376.271 415.995C373.021 418.537 372.927 415.519 374.793 404.913C365.478 406.096 359.855 403.95 349.298 396.417M389.203 317.737C392.234 316.669 395.404 316.827 395.626 314.412M338.213 387.921C341.783 380.017 344.177 377.831 349.667 380.902C347.015 393.866 348.438 398.918 355.949 404.174C360.958 416.251 364.273 420.533 371.467 421.905C375.04 428.482 376.509 432.115 374.793 438.158M338.213 387.921L210.737 413.778M338.213 387.921L354.101 441.113C362.417 441.159 366.912 440.327 374.793 438.158M374.793 438.158C376.88 445.989 375.611 450.26 370.359 457.736C363.37 462.676 359.412 464.373 352.254 464.754C331.997 438.654 340.39 401.053 331.562 400.111C322.734 399.169 316.984 423.738 315.304 461.799M210.737 413.778L175.635 420.427L168.245 380.164C166.906 377.999 165.626 379.141 163.072 382.38C166.363 401.653 165.794 410.278 163.072 424.121C157.65 435.324 153.965 439.038 145.706 438.897C137.693 445.922 135.461 450.692 137.577 461.43C134.694 463.658 127.601 460.322 127.601 460.322C125.62 475.377 123.794 483.187 113.191 490.612V501.324L140.533 526.073M210.737 413.778C214.263 422.127 215.413 426.749 215.171 434.834C258.019 398.2 266.406 401.169 273.551 418.211M140.533 526.073C133.756 535.181 128.829 539.759 118.364 547.129C110.251 561.208 103.158 567.238 87.6956 575.941M140.533 526.073C158.918 536.298 170.264 539.049 201.5 512.406C204.268 491.019 207.279 480.382 215.171 464.016C221.118 468.762 224.258 469.661 229.581 468.818L253.599 418.211C262.295 418.292 267.553 423.014 276.877 430.771C269.291 420.763 267.034 416.772 273.551 418.211M273.551 418.211C288.37 423.096 295.647 426.834 304.958 437.05C300.763 443.739 299.134 448.052 298.307 457.367C314.684 461.21 323.533 463.983 338.582 470.295C344.966 494.309 351.138 506.558 366.294 526.443M366.294 526.443C378.576 543.4 383.979 551.931 390.681 565.229L391.79 581.112C376.017 588.143 370.091 597.215 361.121 616.205C338.826 613.93 328.592 622.584 315.304 659.793C304.88 658.116 299.987 659.37 292.396 664.225M366.294 526.443C258.613 548.562 197.526 558.915 88.0651 575.941L1.23389 585.545L18.2306 657.207H26.3595M292.396 664.225L244.361 630.98L202.978 636.89C202.588 628.895 200.549 626.727 192.263 628.764V625.07L142.75 629.872L116.516 643.909M292.396 664.225C281.843 674.747 275.55 680.397 276.507 698.579C264.003 718.589 254.969 726.936 236.232 738.103C228.427 737.512 226.239 740.165 224.409 747.708C226.151 754.059 225.799 757.326 222.192 762.483M26.3595 657.207C37.3127 698.493 43.7482 721.623 61.831 762.483C62.9862 767.183 63.8817 769.805 68.8514 774.304C65.1555 778.585 64.2312 780.506 64.4174 783.169H214.063L222.192 762.483M26.3595 657.207L116.516 643.909M116.516 643.909C113.092 648.214 111.93 651.232 110.604 657.207C119.641 664.083 123.953 665.971 130.187 665.703C156.58 697.898 173.911 706.913 199.283 738.103C203.905 741.238 206.656 740.947 210.737 751.032C209.787 758.257 212.361 760.72 222.192 762.483M395.626 314.412C396.088 309.398 397.415 306.428 400.288 303.7C396.691 289.868 394.056 279.227 392.671 268.238M395.626 314.412C415.164 302.264 426.671 295.595 456.082 285.969M472.709 202.487C498.179 146.175 519.442 122.138 570.625 93.5166C570.141 83.7887 565.689 77.8722 534.045 64.7042L517.418 8.18743L498.204 1.16901C486.498 13.9635 471.97 5.60169 468.644 5.60169C465.319 5.60169 434.651 112.356 434.651 112.356M472.709 202.487C474.43 205.969 473.745 207.905 471.6 211.352M472.709 202.487C468.399 201.079 465.696 198.161 460.515 190.297L434.651 112.356M434.651 112.356C427.129 113.074 424.685 116.171 423.936 127.131M423.936 127.131C428.182 143.392 430.098 152.194 419.132 158.16C408.27 174.95 416.419 200.463 417.654 230.93M423.936 127.131L365.925 142.646M471.6 211.352C456.467 224.191 444.007 227.911 417.654 230.93M471.6 211.352C472.188 233.681 476.752 241.708 490.445 250.138C495.518 255.636 516.234 246.018 515.234 253.093C514.234 260.169 517.079 256.231 467.536 279.32M417.654 230.93L392.159 236.84M365.925 142.646C373.572 181.446 380.037 201.028 392.159 235.363C391.191 248.289 391.431 258.403 392.671 268.238M365.925 142.646C346.763 144.861 336.229 147.806 317.521 153.727C298.503 175.553 281.808 192.681 277.616 202.487C280.734 206.045 282.724 207.231 287.223 206.181C287.987 225.845 281.419 232.793 266.161 243.12C232.789 241.976 218.494 245.921 196.327 256.418C196.922 263.665 198.391 267.861 206.673 275.996C199.238 287.071 194.791 292.926 184.503 300.375L180.439 304.808M467.536 279.32C467.536 279.32 460.792 284.919 456.082 285.969M467.536 279.32C467.536 279.32 467.297 262.382 462.732 253.093C457.713 255.299 454.745 256.099 449.061 256.418M456.082 285.969C455.465 275.721 454.028 269.316 449.061 256.418M449.061 256.418C427.585 262.979 415.086 265.028 392.671 268.238"
                }
                stroke="white"
                strokeWidth={3}
              />
            </>
          )}
          <Path
            d={
              "M76.2041 684.62C76.2041 684.62 71.7678 671.68 76.2041 668.353C80.6405 665.026 86.5554 667.614 99.4949 659.48C112.434 651.346 93.3719 632.85 87.295 632.122C81.2181 631.393 123.895 605.872 127.222 596.999C130.55 588.126 160.125 604.393 153.84 585.169C147.556 565.944 160.864 560.398 165.67 559.289C170.477 558.18 165.483 551.921 170.476 542.652C175.469 533.383 205.168 526.07 217.428 525.645C229.687 525.221 253.288 468.341 253.288 459.468C253.288 450.594 270.664 431.37 278.427 422.497C286.191 413.624 274.361 391.071 273.252 382.568C272.143 374.065 285.082 382.568 290.997 378.871C296.912 375.174 288.409 367.41 286.561 361.495C284.713 355.579 291.728 340.343 299.13 349.664C306.532 358.985 362.348 326.003 360.13 315.281C357.912 304.559 385.269 296.796 395.621 292.359C405.973 287.923 394.882 261.673 401.906 252.43C408.93 243.188 388.596 176.64 395.621 177.01C402.645 177.38 434.069 171.834 435.548 161.482C437.027 151.13 488.045 97.8921 488.045 97.8921"
            }
            stroke="#D5D5D5"
            strokeWidth={9}
          />
          <AnimatedPath
            d={
              "M76.2041 684.62C76.2041 684.62 71.7678 671.68 76.2041 668.353C80.6405 665.026 86.5554 667.614 99.4949 659.48C112.434 651.346 93.3719 632.85 87.295 632.122C81.2181 631.393 123.895 605.872 127.222 596.999C130.55 588.126 160.125 604.393 153.84 585.169C147.556 565.944 160.864 560.398 165.67 559.289C170.477 558.18 165.483 551.921 170.476 542.652C175.469 533.383 205.168 526.07 217.428 525.645C229.687 525.221 253.288 468.341 253.288 459.468C253.288 450.594 270.664 431.37 278.427 422.497C286.191 413.624 274.361 391.071 273.252 382.568C272.143 374.065 285.082 382.568 290.997 378.871C296.912 375.174 288.409 367.41 286.561 361.495C284.713 355.579 291.728 340.343 299.13 349.664C306.532 358.985 362.348 326.003 360.13 315.281C357.912 304.559 385.269 296.796 395.621 292.359C405.973 287.923 394.882 261.673 401.906 252.43C408.93 243.188 388.596 176.64 395.621 177.01C402.645 177.38 434.069 171.834 435.548 161.482C437.027 151.13 488.045 97.8921 488.045 97.8921"
            }
            stroke="#FC5200"
            strokeWidth={9}
            fill="none"
            strokeDasharray={selectedHike?.pathLength}
            animatedProps={animatedProps}
          />
        </Svg>
      </View>
    </GestureWrapper>
  );
};

const styles = StyleSheet.create({
  container: { flexDirection: "row", alignItems: "center", gap: 10 },
  statsContainer: {
    display: "flex",
    alignItems: "center",
    width: 100,
  },
  label: {
    color: "white",
    marginTop: 10,
    fontSize: 10,
  },
  value: {
    fontSize: 12,
    color: "white",
    fontWeight: "bold",
  },

  percentage: {
    marginTop: 12,
    fontSize: 12,
    color: "white",
    fontWeight: "bold",
    textAlign: "center",
    fontStyle: "italic",
  },
});
