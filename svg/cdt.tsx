import { GestureWrapper } from "@/components/common/GestureWrapper";
import { useUserChoices } from "@/contexts/userChoicesProvider/UserChoicesContextProvider";
import { getMeasurementUnit } from "@/helpers/getMeasurementUnit";
import { MeasurementUnit } from "@/models/measurementUnit";
import React, { useEffect } from "react";
import { useTranslation } from "react-i18next";
import { Image, StyleSheet, Text, View } from "react-native";
import Animated, {
  useAnimatedProps,
  useSharedValue,
  withTiming,
} from "react-native-reanimated";
import Svg, { Path } from "react-native-svg";

export const StickerSmall: React.FC = () => {
  const {
    selectedHike,
    distanceHiked,
    selectedHikeTotalDistance,
    measurementUnit,
    showBorders,
  } = useUserChoices();

  const { t } = useTranslation();

  const AnimatedPath = Animated.createAnimatedComponent(Path);

  const calculatePercentage = () => {
    let newPercentage = 0;
    if (measurementUnit == MeasurementUnit.KILOMETER) {
      newPercentage = Math.round(
        (distanceHiked * 100) / selectedHike?.totalDistanceKilometer!
      );
    } else {
      newPercentage = Math.round(
        (distanceHiked * 100) / selectedHike?.totalDistanceMile!
      );
    }

    return newPercentage;
  };

  const progress = useSharedValue(0);

  const animatedProps = useAnimatedProps(() => {
    const length = selectedHike?.pathLength ?? 0;
    return {
      strokeDashoffset: length - progress.value,
    } as any;
  });

  useEffect(() => {
    if (!selectedHike?.pathLength) return;

    const ratio = Math.max(
      0,
      Math.min(1, distanceHiked / selectedHikeTotalDistance)
    );

    progress.value = 0;
    progress.value = withTiming(ratio * selectedHike.pathLength, {
      duration: 2000,
    });
  }, [distanceHiked, selectedHikeTotalDistance, selectedHike?.pathLength]);

  return (
    <GestureWrapper>
      <View style={styles.container}>
        <View style={styles.statsContainer}>
          <Image
            source={{ uri: selectedHike?.logo }}
            style={{ width: 40, height: 40 }}
          />
          <Text style={styles.percentage}>Continental Divide Trail</Text>
          <Text style={styles.label}>{t("index:sticker.total")}</Text>
          <Text style={styles.value}>
            {selectedHikeTotalDistance} {getMeasurementUnit(measurementUnit)}
          </Text>
          <Text style={styles.label}>{t("index:sticker.distanceHiked")}</Text>
          <Text style={styles.value}>
            {distanceHiked} {getMeasurementUnit(measurementUnit)}
          </Text>
        </View>
        <Svg width={120} height={220} viewBox="0 0 711 767" fill="none">
          {showBorders && (
            <>
              <Path
                d={
                  "M449.13 178.91V3.77096L41.6233 2.60596M449.13 178.91V354.049M449.13 178.91H211.385V311.721M41.6233 2.60596V46.4878C49.5021 53.1509 52.2263 56.7084 54.4429 62.7979C54.4058 72.7016 56.9889 75.8315 65.3201 77.9429C73.4093 80.1905 75.6664 84.4563 78.9166 93.088C79.7772 101.566 95.2324 100.855 99.5056 105.515C103.731 110.123 101.538 113.942 96.9419 121.942L96.7863 122.213C94.4798 132.779 99.5056 133.087 99.5056 136.193C99.5056 139.3 91.7362 145.125 91.7362 145.125C95.208 158.514 102.613 157.94 110.771 149.785C118.929 141.63 136.022 186.677 142.237 188.23C148.453 189.783 167.488 182.793 176.423 185.512C185.358 188.23 210.997 188.23 210.997 188.23M41.6233 2.60596H9.38015C9.38015 2.60596 4.71849 103.961 9.38015 115.223C14.0418 126.485 14.8979 124.329 14.0418 135.028C17.3654 145.761 19.7846 150.939 28.4153 153.668C31.8818 153.353 18.0624 188.64 9.38015 189.395C0.697918 190.151 -1.88557 205.705 4.71849 209.977C11.3225 214.249 13.452 217.665 9.38015 231.335V311.721H109.994M483.704 533.072H517.501V354.437L278.591 353.272M483.704 533.072H280.145M483.704 533.072L483.704 553.265H481.762V752.481H359.393C360.37 756.529 361.107 758.656 363.278 761.801H307.726V781.606H280.145M278.591 353.272H211.385V311.721M278.591 353.272L279.757 533.072M280.145 781.606V533.072M280.145 781.606H209.831L84.7435 731.899C82.4801 727.762 82.8019 725.234 87.0743 720.249C92.5035 719.972 94.6329 719 95.2322 714.424C85.6745 710.422 84.9873 707.776 87.0743 702.774C91.6074 697.436 93.5725 694.176 92.1245 686.076C90.1062 672.342 92.4836 667.562 97.9516 660.057C97.9516 660.057 103.779 655.785 107.663 651.514C111.548 647.242 93.1815 636.246 89.0167 619.67C86.4539 596.004 84.8202 582.36 89.0167 571.517C94.8827 568.601 98.1079 569.748 103.779 575.788C106.571 574.573 107.901 572.634 109.994 567.633V532.295M280.145 533.072L109.994 532.295M109.994 532.295L109.994 311.721M109.994 311.721H211.385"
                }
                stroke="white"
                strokeWidth={4}
              />
              <Path
                d={
                  "M178.86 653.592H177.013L184.769 639.047H186.587L189.513 653.592H187.666L185.365 641.348H185.252L178.86 653.592ZM180.479 647.91H187.922L187.666 649.473H180.223L180.479 647.91ZM191.296 653.592L191.523 652.314L201.296 640.609H193.369L193.625 639.047H203.654L203.455 640.325L193.654 652.03H201.58L201.324 653.592H191.296Z"
                }
                stroke="white"
                strokeWidth={2}
              />
              <Path
                d={
                  "M389.537 638.138L387.122 652.683H385.418L379.395 641.263H379.253L377.349 652.683H375.588L378.003 638.138H379.707L385.759 649.587H385.901L387.804 638.138H389.537ZM393.061 638.138H395.164L398.118 650.212H398.289L405.221 638.138H407.323L404.908 652.683H403.26L405.107 641.632H404.965L398.573 652.683H396.982L394.283 641.632H394.141L392.294 652.683H390.647L393.061 638.138Z"
                }
                stroke="white"
                strokeWidth={2}
              />
              <Path
                d={
                  "M190.223 418.079H191.985L190.394 427.71C190.228 428.704 189.847 429.592 189.25 430.373C188.654 431.15 187.894 431.763 186.97 432.213C186.047 432.658 185.015 432.88 183.874 432.88C182.733 432.88 181.776 432.658 181.004 432.213C180.233 431.763 179.679 431.15 179.342 430.373C179.006 429.592 178.921 428.704 179.087 427.71L180.678 418.079H182.439L180.862 427.568C180.749 428.278 180.803 428.91 181.026 429.464C181.248 430.013 181.622 430.446 182.148 430.764C182.678 431.076 183.348 431.232 184.158 431.232C184.967 431.232 185.69 431.076 186.324 430.764C186.958 430.446 187.475 430.013 187.872 429.464C188.275 428.91 188.533 428.278 188.646 427.568L190.223 418.079ZM194.451 419.642L194.706 418.079H205.616L205.36 419.642H200.786L198.627 432.625H196.866L199.025 419.642H194.451Z"
                }
                stroke="white"
                strokeWidth={2}
              />
              <Path
                d={
                  "M395.306 439.902H393.573C393.554 439.395 393.45 438.95 393.26 438.567C393.071 438.183 392.815 437.861 392.493 437.601C392.176 437.336 391.811 437.137 391.399 437.004C390.987 436.872 390.547 436.805 390.078 436.805C389.179 436.805 388.326 437.035 387.522 437.494C386.717 437.949 386.028 438.619 385.455 439.504C384.882 440.385 384.491 441.464 384.283 442.743C384.075 443.983 384.105 445.027 384.375 445.875C384.645 446.722 385.093 447.364 385.718 447.8C386.343 448.235 387.086 448.453 387.948 448.453C388.445 448.453 388.933 448.387 389.411 448.254C389.894 448.122 390.343 447.925 390.76 447.665C391.182 447.399 391.556 447.075 391.882 446.692C392.214 446.303 392.474 445.858 392.664 445.356H394.425C394.165 446.1 393.812 446.765 393.367 447.352C392.926 447.939 392.417 448.439 391.84 448.851C391.262 449.258 390.639 449.568 389.972 449.781C389.304 449.994 388.611 450.101 387.891 450.101C386.631 450.101 385.559 449.793 384.674 449.177C383.793 448.557 383.163 447.681 382.784 446.55C382.41 445.413 382.351 444.069 382.607 442.515C382.862 441 383.352 439.694 384.077 438.595C384.801 437.492 385.689 436.644 386.74 436.052C387.791 435.456 388.933 435.158 390.164 435.158C390.902 435.158 391.582 435.264 392.202 435.477C392.822 435.69 393.362 436.003 393.821 436.415C394.281 436.822 394.638 437.319 394.894 437.906C395.154 438.489 395.291 439.154 395.306 439.902ZM409.97 442.743C409.714 444.258 409.224 445.567 408.5 446.67C407.775 447.769 406.89 448.616 405.844 449.213C404.797 449.805 403.663 450.101 402.442 450.101C401.182 450.101 400.11 449.793 399.224 449.177C398.344 448.557 397.714 447.681 397.335 446.55C396.961 445.413 396.902 444.069 397.158 442.515C397.413 441 397.903 439.694 398.628 438.595C399.352 437.492 400.24 436.644 401.291 436.052C402.342 435.456 403.483 435.158 404.714 435.158C405.964 435.158 407.027 435.468 407.903 436.088C408.784 436.703 409.411 437.579 409.785 438.716C410.164 439.847 410.226 441.19 409.97 442.743ZM408.294 442.515C408.502 441.275 408.471 440.231 408.202 439.383C407.932 438.536 407.484 437.894 406.859 437.459C406.234 437.023 405.491 436.805 404.629 436.805C403.73 436.805 402.877 437.035 402.072 437.494C401.267 437.949 400.578 438.619 400.006 439.504C399.433 440.385 399.042 441.464 398.834 442.743C398.625 443.983 398.656 445.027 398.926 445.875C399.196 446.722 399.643 447.364 400.268 447.8C400.893 448.235 401.637 448.453 402.498 448.453C403.398 448.453 404.25 448.226 405.055 447.771C405.86 447.312 406.549 446.642 407.122 445.761C407.695 444.876 408.086 443.794 408.294 442.515Z"
                }
                stroke="white"
                strokeWidth={2}
              />
              <Path
                d={
                  "M321.851 269.854L320.289 255.308H322.079L323.158 267.155H323.3L328.357 255.308H330.346L331.482 267.155H331.624L336.624 255.308H338.414L332.022 269.854H330.204L328.925 258.263H328.812L323.67 269.854H321.851ZM339.359 255.308H341.376L344.302 262.098H344.472L349.614 255.308H351.631L344.955 263.859L343.961 269.854H342.2L343.194 263.859L339.359 255.308Z"
                }
                stroke="white"
                strokeWidth={2}
              />
              <Path
                d={
                  "M82.4124 197.111L79.9977 211.656H78.2363L80.6511 197.111H82.4124ZM88.0747 211.656H83.5293L85.944 197.111H90.5747C91.9857 197.111 93.1481 197.407 94.0619 197.999C94.9805 198.591 95.6197 199.436 95.9796 200.534C96.3441 201.633 96.3986 202.944 96.1429 204.469C95.8967 205.965 95.4185 207.251 94.7083 208.326C94.0028 209.396 93.0889 210.219 91.9668 210.797C90.8494 211.37 89.552 211.656 88.0747 211.656ZM85.5534 210.094H88.1315C89.3342 210.094 90.3711 209.857 91.2423 209.384C92.1183 208.91 92.8238 208.236 93.3588 207.36C93.8986 206.484 94.2679 205.444 94.4668 204.242C94.6656 203.086 94.6467 202.094 94.41 201.266C94.1779 200.433 93.721 199.793 93.0392 199.348C92.3621 198.898 91.4554 198.674 90.319 198.674H87.4426L85.5534 210.094Z"
                }
                stroke="white"
                strokeWidth={2}
              />
              <Path
                d={
                  "M247.059 82.5351H249.161L252.116 94.609H252.286L259.218 82.5351H261.32L258.906 97.0806H257.258L259.104 86.0294H258.962L252.57 97.0806H250.979L248.281 86.0294H248.139L246.292 97.0806H244.644L247.059 82.5351ZM263.801 84.0976L264.057 82.5351H274.966L274.71 84.0976H270.136L267.977 97.0806H266.216L268.375 84.0976H263.801Z"
                }
                stroke="white"
                strokeWidth={2}
              />
            </>
          )}
          <Path
            d={
              "M305.153 770.426C299.085 756.179 288.837 742.482 289.614 733.943C290.391 725.404 311.757 699.4 318.362 698.236C324.966 697.072 318.362 683.487 318.362 676.889C318.362 670.291 305.153 676.889 299.326 676.889C293.499 676.889 298.549 663.693 301.657 657.871C304.765 652.05 309.427 650.885 308.65 648.168C307.873 645.452 301.657 637.689 299.326 634.196C296.995 630.703 313.311 631.479 311.757 627.598C310.203 623.717 308.65 618.283 310.203 614.79C311.757 611.297 319.139 607.028 321.469 607.028C323.8 607.028 369.252 550.75 371.195 547.645C373.137 544.54 356.432 514.267 353.325 510.774C350.217 507.281 329.239 503.011 327.297 499.518C325.354 496.025 368.864 483.605 371.195 474.291C373.525 464.976 361.094 439.36 365.367 431.985C369.641 424.611 382.849 423.059 385.18 418.789C387.511 414.52 391.395 400.16 388.676 392.785C385.957 385.411 360.143 396.053 360.317 385.411C360.491 374.769 338.562 344.27 331.958 341.165C325.354 338.06 342.059 331.85 338.562 322.535C335.066 313.221 322.369 293.363 311.757 297.308C301.146 301.252 266.325 291.904 248.047 247.628C244.646 227.487 239.866 218.938 224.35 210.369C216.91 211.177 209.588 194.844 199.876 192.515C190.164 190.186 158.697 207.652 150.151 204.159C141.604 200.666 111.303 153.703 115.964 145.941C120.626 138.178 126.842 129.64 136.942 129.64C147.043 129.64 156.755 139.731 163.747 139.343C170.74 138.955 171.128 133.133 170.74 129.64C170.351 126.147 161.416 123.43 160.639 117.996C159.863 112.562 173.071 105.188 170.74 98.2019C168.409 91.2157 166.467 90.0513 163.747 86.5583C161.028 83.0652 174.993 81.3958 170.74 79.184C166.487 76.9721 140.36 48.7658 142.381 46.1937C143.827 23.3639 140.062 15.9413 132.669 3.50049"
            }
            stroke="#D5D5D5"
            strokeWidth={12}
          />
          <AnimatedPath
            d={
              "M305.153 770.426C299.085 756.179 288.837 742.482 289.614 733.943C290.391 725.404 311.757 699.4 318.362 698.236C324.966 697.072 318.362 683.487 318.362 676.889C318.362 670.291 305.153 676.889 299.326 676.889C293.499 676.889 298.549 663.693 301.657 657.871C304.765 652.05 309.427 650.885 308.65 648.168C307.873 645.452 301.657 637.689 299.326 634.196C296.995 630.703 313.311 631.479 311.757 627.598C310.203 623.717 308.65 618.283 310.203 614.79C311.757 611.297 319.139 607.028 321.469 607.028C323.8 607.028 369.252 550.75 371.195 547.645C373.137 544.54 356.432 514.267 353.325 510.774C350.217 507.281 329.239 503.011 327.297 499.518C325.354 496.025 368.864 483.605 371.195 474.291C373.525 464.976 361.094 439.36 365.367 431.985C369.641 424.611 382.849 423.059 385.18 418.789C387.511 414.52 391.395 400.16 388.676 392.785C385.957 385.411 360.143 396.053 360.317 385.411C360.491 374.769 338.562 344.27 331.958 341.165C325.354 338.06 342.059 331.85 338.562 322.535C335.066 313.221 322.369 293.363 311.757 297.308C301.146 301.252 266.325 291.904 248.047 247.628C244.646 227.487 239.866 218.938 224.35 210.369C216.91 211.177 209.588 194.844 199.876 192.515C190.164 190.186 158.697 207.652 150.151 204.159C141.604 200.666 111.303 153.703 115.964 145.941C120.626 138.178 126.842 129.64 136.942 129.64C147.043 129.64 156.755 139.731 163.747 139.343C170.74 138.955 171.128 133.133 170.74 129.64C170.351 126.147 161.416 123.43 160.639 117.996C159.863 112.562 173.071 105.188 170.74 98.2019C168.409 91.2157 166.467 90.0513 163.747 86.5583C161.028 83.0652 174.993 81.3958 170.74 79.184C166.487 76.9721 140.36 48.7658 142.381 46.1937C143.827 23.3639 140.062 15.9413 132.669 3.50049"
            }
            stroke="#FC5200"
            strokeWidth={12}
            fill="none"
            strokeDasharray={selectedHike?.pathLength}
            animatedProps={animatedProps}
          />
        </Svg>
      </View>
    </GestureWrapper>
  );
};

const styles = StyleSheet.create({
  container: { flexDirection: "row", alignItems: "center", gap: 10 },
  statsContainer: {
    display: "flex",
    alignItems: "center",
    width: 100,
  },
  label: {
    color: "white",
    marginTop: 10,
    fontSize: 10,
  },
  value: {
    fontSize: 12,
    color: "white",
    fontWeight: "bold",
  },

  percentage: {
    marginTop: 12,
    fontSize: 12,
    color: "white",
    fontWeight: "bold",
    textAlign: "center",
    fontStyle: "italic",
  },
});
