import { GestureWrapper } from "@/components/common/GestureWrapper";
import { useUserChoices } from "@/contexts/userChoicesProvider/UserChoicesContextProvider";
import { getMeasurementUnit } from "@/helpers/getMeasurementUnit";
import { MeasurementUnit } from "@/models/measurementUnit";
import React, { useEffect } from "react";
import { useTranslation } from "react-i18next";
import { Image, StyleSheet, Text, View } from "react-native";
import Animated, {
  useAnimatedProps,
  useSharedValue,
  withTiming,
} from "react-native-reanimated";
import Svg, { Path } from "react-native-svg";

export const StickerSmall: React.FC = () => {
  const {
    selectedHike,
    distanceHiked,
    selectedHikeTotalDistance,
    measurementUnit,
    showBorders,
  } = useUserChoices();

  const { t } = useTranslation();

  const AnimatedPath = Animated.createAnimatedComponent(Path);

  const calculatePercentage = () => {
    let newPercentage = 0;
    if (measurementUnit == MeasurementUnit.KILOMETER) {
      newPercentage = Math.round(
        (distanceHiked * 100) / selectedHike?.totalDistanceKilometer!
      );
    } else {
      newPercentage = Math.round(
        (distanceHiked * 100) / selectedHike?.totalDistanceMile!
      );
    }

    return newPercentage;
  };

  const progress = useSharedValue(0);

  const animatedProps = useAnimatedProps(() => {
    const length = selectedHike?.pathLength ?? 0;
    return {
      strokeDashoffset: length - progress.value,
    } as any;
  });

  useEffect(() => {
    if (!selectedHike?.pathLength) return;

    const ratio = Math.max(
      0,
      Math.min(1, distanceHiked / selectedHikeTotalDistance)
    );

    progress.value = 0;
    progress.value = withTiming(ratio * selectedHike.pathLength, {
      duration: 2000,
    });
  }, [distanceHiked, selectedHikeTotalDistance, selectedHike?.pathLength]);

  return (
    <GestureWrapper>
      <View style={styles.container}>
        <View style={styles.statsContainer}>
          <Image
            source={{ uri: selectedHike?.logo }}
            style={{ width: 40, height: 40 }}
          />
          <Text style={styles.percentage}>GR20</Text>
          <Text style={styles.label}>{t("index:sticker.total")}</Text>
          <Text style={styles.value}>
            {selectedHikeTotalDistance} {getMeasurementUnit(measurementUnit)}
          </Text>
          <Text style={styles.label}>{t("index:sticker.distanceHiked")}</Text>
          <Text style={styles.value}>
            {distanceHiked} {getMeasurementUnit(measurementUnit)}
          </Text>
        </View>
        <Svg width={120} height={220} viewBox="0 0 711 767" fill="none">
          {showBorders && (
            <>
              <Path
                d={
                  "M359.06 434.66C353.663 439.608 315.658 494.254 310.036 506.397C304.414 518.54 311.835 617.263 304.639 628.507C297.443 639.751 292.271 663.813 292.945 676.856C293.62 689.899 268.209 699.119 262.587 704.966C256.964 710.813 269.333 730.378 262.587 736.224C255.84 742.071 244.596 738.923 243.247 748.593C241.897 758.262 243.697 757.138 257.864 753.765C272.031 750.391 248.419 780.076 238.749 782.55C229.079 785.023 200.744 776.927 196.922 767.483C193.099 758.038 213.338 743.42 203.218 746.119C193.099 748.818 81.7562 703.212 86.5055 674.832C91.2547 646.452 135.079 642.899 131.481 631.88C127.884 620.861 39.464 615.409 47.8262 603.095C56.1883 590.782 118.528 520.772 82.6825 521.464C46.8369 522.156 37.4815 544.851 28.9362 534.282C20.391 523.713 17.9169 510.445 19.0415 501.674C20.1661 492.904 68.7398 470.866 72.7878 457.598C76.8358 444.33 48.2934 427.204 19.0415 423.416C10.7058 425.972 -5.1663 379.291 3.5248 371.694C12.2159 364.096 48.9506 369.895 54.7974 358.651C60.6442 347.407 -11.767 312.325 3.5248 311.651C18.8166 310.977 39.3662 258.281 47.8262 242.838C56.2862 227.394 102.64 213.019 95.7256 202.134C87.7987 199.585 174.276 174.448 185.453 174.699C196.63 174.95 184.103 164.354 185.453 157.608C186.802 150.862 230.281 125.45 241.448 139.843C252.614 154.235 257.864 179.196 278.778 155.584C299.692 131.972 263.261 89.9189 272.931 88.1201C282.601 86.3213 276.979 60.2352 276.979 60.2352C276.979 60.2352 287.548 57.0867 290.472 48.5414C293.395 39.9962 282.376 20.6563 284.625 15.0343C286.874 9.41231 307.562 -0.032638 314.759 1.09176C321.955 2.21616 330.05 11.4362 328.701 18.6324C327.352 25.8286 325.553 32.3501 328.701 40.4458C331.85 48.5414 343.543 99.3643 336.797 110.608C330.05 121.852 326.452 153.111 321.955 163.905C317.457 174.699 348.266 212.929 351.864 220.575C355.462 228.22 353.438 245.087 351.864 252.957C350.29 260.828 355.012 271.173 356.361 281.517C357.711 291.862 351.864 302.656 351.864 313.9C351.864 325.144 361.084 338.187 361.759 349.881C362.433 361.574 357.936 373.268 359.06 378.215C360.184 383.163 364.457 429.713 359.06 434.66Z"
                }
                stroke="white"
                strokeWidth={4}
              />
              <Path
                d={
                  "M147.511 407H143.179C143.132 405.733 142.871 404.62 142.398 403.662C141.924 402.703 141.285 401.898 140.48 401.247C139.687 400.584 138.776 400.087 137.746 399.755C136.716 399.424 135.615 399.258 134.443 399.258C132.194 399.258 130.063 399.832 128.051 400.981C126.039 402.117 124.317 403.792 122.884 406.005C121.452 408.207 120.475 410.906 119.955 414.102C119.434 417.203 119.511 419.813 120.185 421.932C120.86 424.051 121.979 425.655 123.541 426.744C125.104 427.833 126.962 428.378 129.116 428.378C130.359 428.378 131.579 428.212 132.774 427.88C133.982 427.549 135.106 427.058 136.148 426.407C137.201 425.744 138.136 424.933 138.953 423.974C139.782 423.004 140.433 421.891 140.906 420.636H145.31C144.659 422.495 143.777 424.158 142.664 425.625C141.563 427.093 140.291 428.342 138.847 429.372C137.402 430.39 135.846 431.165 134.177 431.698C132.508 432.231 130.774 432.497 128.974 432.497C125.826 432.497 123.145 431.728 120.931 430.189C118.729 428.638 117.155 426.448 116.208 423.619C115.273 420.778 115.125 417.416 115.764 413.534C116.403 409.746 117.629 406.479 119.44 403.733C121.251 400.975 123.47 398.856 126.098 397.376C128.726 395.885 131.579 395.139 134.656 395.139C136.503 395.139 138.201 395.405 139.752 395.938C141.303 396.471 142.652 397.252 143.8 398.282C144.949 399.3 145.842 400.543 146.482 402.01C147.133 403.466 147.476 405.129 147.511 407ZM184.172 414.102C183.533 417.89 182.308 421.163 180.497 423.921C178.686 426.667 176.472 428.786 173.856 430.277C171.24 431.757 168.405 432.497 165.351 432.497C162.203 432.497 159.522 431.728 157.308 430.189C155.106 428.638 153.532 426.448 152.585 423.619C151.65 420.778 151.502 417.416 152.141 413.534C152.78 409.746 154.006 406.479 155.817 403.733C157.628 400.975 159.847 398.856 162.475 397.376C165.103 395.885 167.956 395.139 171.033 395.139C174.158 395.139 176.816 395.914 179.006 397.465C181.207 399.004 182.776 401.194 183.711 404.035C184.658 406.864 184.812 410.219 184.172 414.102ZM179.982 413.534C180.503 410.433 180.426 407.822 179.751 405.704C179.077 403.585 177.958 401.981 176.395 400.892C174.833 399.803 172.974 399.258 170.82 399.258C168.571 399.258 166.44 399.832 164.428 400.981C162.416 402.117 160.693 403.792 159.261 406.005C157.829 408.207 156.852 410.906 156.331 414.102C155.811 417.203 155.888 419.813 156.562 421.932C157.237 424.051 158.356 425.655 159.918 426.744C161.481 427.833 163.339 428.378 165.493 428.378C167.742 428.378 169.873 427.809 171.885 426.673C173.898 425.525 175.62 423.85 177.052 421.648C178.485 419.435 179.461 416.73 179.982 413.534ZM188.594 432L194.631 395.636H206.917C209.758 395.636 212.007 396.116 213.665 397.074C215.334 398.033 216.464 399.353 217.056 401.034C217.66 402.715 217.784 404.632 217.429 406.787C217.074 408.917 216.316 410.811 215.156 412.469C214.008 414.126 212.445 415.428 210.469 416.375C208.504 417.322 206.113 417.795 203.295 417.795H193.352L194.062 413.818H203.863C205.805 413.818 207.415 413.534 208.693 412.966C209.971 412.397 210.966 411.587 211.676 410.533C212.386 409.48 212.86 408.231 213.096 406.787C213.333 405.319 213.268 404.046 212.901 402.969C212.546 401.88 211.818 401.04 210.717 400.448C209.628 399.844 208.101 399.542 206.136 399.542H198.395L192.997 432H188.594ZM208.409 415.665L214.659 432H209.545L203.437 415.665H208.409ZM244.937 405.011C244.937 403.058 244.292 401.578 243.001 400.572C241.711 399.554 239.965 399.045 237.763 399.045C236.154 399.045 234.704 399.306 233.413 399.826C232.123 400.347 231.07 401.063 230.253 401.975C229.436 402.886 228.933 403.922 228.744 405.082C228.59 406.053 228.69 406.887 229.045 407.586C229.401 408.272 229.904 408.846 230.555 409.308C231.218 409.758 231.928 410.131 232.685 410.427C233.443 410.711 234.141 410.942 234.781 411.119L238.332 412.113C239.219 412.362 240.208 412.705 241.297 413.143C242.386 413.581 243.404 414.179 244.351 414.937C245.298 415.682 246.02 416.641 246.517 417.813C247.026 418.985 247.138 420.423 246.854 422.128C246.523 424.093 245.712 425.868 244.422 427.454C243.143 429.04 241.451 430.301 239.344 431.236C237.249 432.171 234.804 432.639 232.011 432.639C229.406 432.639 227.217 432.219 225.441 431.378C223.677 430.538 222.375 429.366 221.535 427.863C220.706 426.359 220.387 424.613 220.576 422.625H225.121C225.003 423.998 225.275 425.134 225.938 426.034C226.601 426.922 227.524 427.585 228.708 428.022C229.892 428.449 231.206 428.662 232.65 428.662C234.331 428.662 235.881 428.389 237.302 427.845C238.734 427.289 239.918 426.519 240.853 425.537C241.8 424.542 242.38 423.382 242.593 422.057C242.806 420.849 242.64 419.867 242.096 419.109C241.551 418.352 240.764 417.736 239.734 417.263C238.705 416.789 237.574 416.375 236.343 416.02L232.082 414.741C229.383 413.924 227.329 412.759 225.92 411.243C224.524 409.728 224.021 407.745 224.411 405.295C224.766 403.259 225.625 401.484 226.986 399.969C228.347 398.442 230.034 397.258 232.046 396.417C234.058 395.565 236.225 395.139 238.545 395.139C240.888 395.139 242.895 395.565 244.564 396.417C246.233 397.258 247.476 398.424 248.293 399.915C249.109 401.395 249.411 403.094 249.198 405.011H244.937ZM252.461 432L258.498 395.636H280.444L279.805 399.542H262.262L260.202 411.829H276.608L275.969 415.736H259.563L257.503 428.094H275.33L274.691 432H252.461Z"
                }
                stroke="white"
                strokeWidth={6}
              />
            </>
          )}
          <Path
            d={
              "M274.64 621.086C272.649 597.394 273.183 585.445 267.219 582.856C261.255 580.267 245.697 579.994 245.181 576.559C245.744 558.395 245.013 554.512 241.807 558.569C232.468 564.662 228.897 563.128 223.142 558.569C217.255 554.45 251.296 505.403 245.181 501.674C239.065 497.946 244.923 481.046 245.181 478.737C237.337 476.381 233.336 471.391 226.516 459.622C221.32 452.656 224.492 438.033 223.142 433.761C221.793 429.488 217.52 424.541 213.023 422.517C208.525 420.493 199.755 418.694 199.755 418.694C191.999 398.768 187.003 392.402 177.717 383.837C177.717 383.837 165.348 382.938 158.152 380.014C150.956 377.091 148.932 358.201 144.434 360.9C139.937 363.598 107.755 333.547 113.626 331.89C119.497 330.233 136.564 312.101 133.19 304.68C129.817 297.259 138.588 290.512 133.19 286.015C127.793 281.517 106.879 273.196 102.382 268.024C97.8843 262.852 106.879 243.512 106.879 243.512"
            }
            stroke="#D5D5D5"
            strokeWidth={12}
          />
          <AnimatedPath
            d={
              "M274.64 621.086C272.649 597.394 273.183 585.445 267.219 582.856C261.255 580.267 245.697 579.994 245.181 576.559C245.744 558.395 245.013 554.512 241.807 558.569C232.468 564.662 228.897 563.128 223.142 558.569C217.255 554.45 251.296 505.403 245.181 501.674C239.065 497.946 244.923 481.046 245.181 478.737C237.337 476.381 233.336 471.391 226.516 459.622C221.32 452.656 224.492 438.033 223.142 433.761C221.793 429.488 217.52 424.541 213.023 422.517C208.525 420.493 199.755 418.694 199.755 418.694C191.999 398.768 187.003 392.402 177.717 383.837C177.717 383.837 165.348 382.938 158.152 380.014C150.956 377.091 148.932 358.201 144.434 360.9C139.937 363.598 107.755 333.547 113.626 331.89C119.497 330.233 136.564 312.101 133.19 304.68C129.817 297.259 138.588 290.512 133.19 286.015C127.793 281.517 106.879 273.196 102.382 268.024C97.8843 262.852 106.879 243.512 106.879 243.512"
            }
            stroke="#FC5200"
            strokeWidth={12}
            fill="none"
            strokeDasharray={selectedHike?.pathLength}
            animatedProps={animatedProps}
          />
        </Svg>
      </View>
    </GestureWrapper>
  );
};

const styles = StyleSheet.create({
  container: { flexDirection: "row", alignItems: "center", gap: 10 },
  statsContainer: {
    display: "flex",
    alignItems: "center",
    width: 100,
  },
  label: {
    color: "white",
    marginTop: 10,
    fontSize: 10,
  },
  value: {
    fontSize: 12,
    color: "white",
    fontWeight: "bold",
  },

  percentage: {
    marginTop: 12,
    fontSize: 12,
    color: "white",
    fontWeight: "bold",
    textAlign: "center",
    fontStyle: "italic",
  },
});
