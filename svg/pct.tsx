import { GestureWrapper } from "@/components/common/GestureWrapper";
import { useUserChoices } from "@/contexts/userChoicesProvider/UserChoicesContextProvider";
import { getMeasurementUnit } from "@/helpers/getMeasurementUnit";
import { MeasurementUnit } from "@/models/measurementUnit";
import React, { useEffect } from "react";
import { useTranslation } from "react-i18next";
import { Image, StyleSheet, Text, View } from "react-native";
import Animated, {
  useAnimatedProps,
  useSharedValue,
  withTiming,
} from "react-native-reanimated";
import Svg, { Path } from "react-native-svg";

export const StickerSmall: React.FC = () => {
  const {
    selectedHike,
    distanceHiked,
    selectedHikeTotalDistance,
    measurementUnit,
    showBorders,
  } = useUserChoices();

  const { t } = useTranslation();

  const AnimatedPath = Animated.createAnimatedComponent(Path);

  const calculatePercentage = () => {
    let newPercentage = 0;
    if (measurementUnit == MeasurementUnit.KILOMETER) {
      newPercentage = Math.round(
        (distanceHiked * 100) / selectedHike?.totalDistanceKilometer!
      );
    } else {
      newPercentage = Math.round(
        (distanceHiked * 100) / selectedHike?.totalDistanceMile!
      );
    }

    return newPercentage;
  };

  const progress = useSharedValue(0);

  const animatedProps = useAnimatedProps(() => {
    const length = selectedHike?.pathLength ?? 0;
    return {
      strokeDashoffset: length - progress.value,
    } as any;
  });

  useEffect(() => {
    if (!selectedHike?.pathLength) return;

    const ratio = Math.max(
      0,
      Math.min(1, distanceHiked / selectedHikeTotalDistance)
    );

    progress.value = 0;
    progress.value = withTiming(ratio * selectedHike.pathLength, {
      duration: 2000,
    });
  }, [distanceHiked, selectedHikeTotalDistance, selectedHike?.pathLength]);

  return (
    <GestureWrapper>
      <View style={styles.container}>
        <View style={styles.statsContainer}>
          <Image
            source={{ uri: selectedHike?.logo }}
            style={{ width: 40, height: 40 }}
          />
          <Text style={styles.percentage}>Pacific Crest Trail</Text>
          <Text style={styles.label}>{t("index:sticker.total")}</Text>
          <Text style={styles.value}>
            {selectedHikeTotalDistance} {getMeasurementUnit(measurementUnit)}
          </Text>
          <Text style={styles.label}>{t("index:sticker.distanceHiked")}</Text>
          <Text style={styles.value}>
            {distanceHiked} {getMeasurementUnit(measurementUnit)}
          </Text>
        </View>
        <Svg
          preserveAspectRatio="xMidYMid meet"
          width={120}
          height={160}
          viewBox="0 0 384 784"
          fill="none"
        >
          {showBorders && (
            <>
              <Path
                d={
                  "M170.492 334.237L173.165 479.33C173.165 479.33 356.068 659.933 361.413 665.661C366.759 671.388 390.052 690.479 380.887 701.552C371.723 712.625 364.947 721.79 361.413 743.171C360.085 747.054 377.451 770.662 367.905 772.19C358.358 773.717 275.499 782.881 275.499 782.881C275.96 776.546 280.462 767.608 260.225 743.171C239.987 718.734 230.823 722.934 222.804 718.734C214.786 714.534 212.495 716.825 203.331 712.625C194.166 708.425 207.281 694.91 191.493 696.207C175.706 697.503 148.727 693.534 148.727 685.897C148.727 678.261 151.221 670.379 148.727 661.461C140.29 662.725 137.914 658.968 136.89 646.188C104.588 616.451 103.938 612.409 101.379 604.187C96.0069 591.884 102.906 586.623 110.161 583.95C117.416 581.277 105.961 574.786 105.961 574.786C105.961 574.786 96.4146 576.314 91.8325 571.35C87.2504 566.386 78.468 556.459 79.6136 546.531C80.7591 536.604 83.432 532.786 79.6136 531.258C75.7952 529.731 67.3946 525.913 64.3399 518.658C61.2851 511.403 42.193 490.403 37.6109 479.33C33.0288 468.257 40.6657 453.748 37.6109 445.348C34.5562 436.948 26.9193 433.129 23.4828 427.402C20.0462 421.675 14.7004 423.965 12.7912 412.511C10.882 401.056 21.5735 393.419 23.4828 386.165C25.392 378.91 20.0462 334.237 20.0462 334.237M170.492 334.237H20.0462M170.492 334.237H278.553V247.944L280.463 233.435L270.535 220.453L287.336 186.089L296.118 162.797L290.391 154.015L280.463 145.233M20.0462 334.237C20.0462 334.237 14.7004 332.327 13.5549 326.982C12.4093 321.636 15.0822 312.473 13.5549 305.982C12.0275 299.491 10.3262 298.804 7.82722 294.909C5.32823 291.013 22.3372 265.508 23.1009 255.199C23.8646 244.89 20.6616 217.43 26.1557 194.107C26.1557 194.107 26.1557 174.252 29.5922 170.052C33.0288 165.852 23.8646 162.415 26.1557 154.015C28.4467 145.615 29.5922 132.633 29.5922 132.633M280.463 145.233C246.992 143.593 209.007 147.687 186.148 149.433C175.918 150.742 167.819 152.87 162.855 155.543C157.891 158.215 134.98 162.415 129.253 161.27C123.526 160.125 97.1786 164.706 94.1236 166.616C91.0686 168.525 78.4678 163.561 75.413 160.506C72.3583 157.452 72.3583 152.87 71.213 150.579C70.0678 148.288 65.4851 142.942 55.9393 137.597C46.3936 132.251 29.5922 132.633 29.5922 132.633M280.463 145.233L276.644 129.96V2.81268C276.644 2.81268 75.0318 0.139903 69.3038 1.28538C63.5759 2.43085 81.1412 12.7401 79.6136 15.0311C78.0859 17.322 59.7578 17.322 59.7578 17.322C59.7578 17.322 52.5031 19.2311 52.5028 24.9585C52.5025 30.6859 55.1757 30.3041 57.4667 32.2132C59.7578 34.1223 68.1586 31.0677 69.3038 34.1223C70.4491 37.1769 71.977 41.377 67.3946 41.377C62.8122 41.377 27.3009 44.0498 23.8646 41.377L23.7767 41.3086C20.2249 38.5456 8.17423 29.1713 4.0088 30.6859C-0.191695 32.2132 0.190375 46.7225 4.0088 54.7409C7.82722 62.7592 24.8001 105.207 23.8646 110.869C22.9291 116.531 33.0288 106.287 33.7925 109.342C34.5562 112.396 30.3559 119.269 29.5922 123.088C28.8285 126.906 23.8646 127.669 23.8646 127.669C23.8646 127.669 21.5735 130.724 23.8646 132.633C26.1557 134.542 29.5922 132.633 29.5922 132.633"
                }
                stroke="white"
                strokeWidth={3}
              />
              <Path
                stroke="white"
                strokeWidth={4}
                d={
                  "M126.989 93L123.864 63.9091H127.443L129.602 87.6023H129.886L140 63.9091H143.977L146.25 87.6023H146.534L156.534 63.9091H160.114L147.33 93H143.693L141.136 69.8182H140.909L130.625 93H126.989ZM158.601 93H154.908L170.419 63.9091H174.055L179.908 93H176.214L171.612 68.5114H171.385L158.601 93ZM161.839 81.6364H176.726L176.214 84.7614H161.328L161.839 81.6364Z"
                }
              />
              <Path
                stroke="white"
                strokeWidth={4}
                d={
                  "M148.636 245.682C148.125 248.712 147.145 251.33 145.696 253.537C144.247 255.734 142.476 257.429 140.384 258.622C138.291 259.806 136.023 260.398 133.58 260.398C131.061 260.398 128.916 259.782 127.145 258.551C125.384 257.311 124.124 255.559 123.366 253.295C122.618 251.023 122.5 248.333 123.011 245.227C123.523 242.197 124.503 239.583 125.952 237.386C127.401 235.18 129.176 233.485 131.278 232.301C133.381 231.108 135.663 230.511 138.125 230.511C140.625 230.511 142.751 231.132 144.503 232.372C146.264 233.603 147.519 235.355 148.267 237.628C149.025 239.891 149.148 242.576 148.636 245.682ZM145.284 245.227C145.701 242.746 145.639 240.658 145.099 238.963C144.56 237.268 143.665 235.985 142.415 235.114C141.165 234.242 139.678 233.807 137.955 233.807C136.155 233.807 134.451 234.266 132.841 235.185C131.231 236.094 129.853 237.434 128.707 239.205C127.562 240.966 126.78 243.125 126.364 245.682C125.947 248.163 126.009 250.251 126.548 251.946C127.088 253.641 127.983 254.924 129.233 255.795C130.483 256.667 131.97 257.102 133.693 257.102C135.492 257.102 137.197 256.648 138.807 255.739C140.417 254.82 141.795 253.48 142.94 251.719C144.086 249.948 144.867 247.784 145.284 245.227ZM152.173 260L157.003 230.909H166.832C169.105 230.909 170.904 231.293 172.23 232.06C173.565 232.827 174.47 233.883 174.943 235.227C175.426 236.572 175.526 238.106 175.241 239.83C174.957 241.534 174.351 243.049 173.423 244.375C172.505 245.701 171.255 246.742 169.673 247.5C168.101 248.258 166.188 248.636 163.935 248.636H155.98L156.548 245.455H164.389C165.942 245.455 167.23 245.227 168.253 244.773C169.276 244.318 170.071 243.67 170.639 242.827C171.207 241.984 171.586 240.985 171.776 239.83C171.965 238.655 171.913 237.637 171.619 236.776C171.335 235.904 170.753 235.232 169.872 234.759C169.001 234.276 167.779 234.034 166.207 234.034H160.014L155.696 260H152.173ZM168.026 246.932L173.026 260H168.935L164.048 246.932H168.026Z"
                }
              />
              <Path
                stroke="white"
                strokeWidth={4}
                d={
                  "M163.257 555.39H159.791C159.753 554.376 159.545 553.486 159.166 552.719C158.787 551.952 158.276 551.308 157.632 550.787C156.997 550.257 156.268 549.859 155.444 549.594C154.62 549.329 153.74 549.196 152.802 549.196C151.003 549.196 149.298 549.656 147.689 550.574C146.079 551.483 144.701 552.823 143.555 554.594C142.409 556.356 141.628 558.515 141.211 561.071C140.795 563.553 140.856 565.641 141.396 567.336C141.936 569.031 142.831 570.314 144.081 571.185C145.331 572.056 146.817 572.492 148.541 572.492C149.535 572.492 150.511 572.359 151.467 572.094C152.433 571.829 153.333 571.436 154.166 570.915C155.009 570.385 155.757 569.736 156.41 568.969C157.073 568.193 157.594 567.303 157.973 566.299H161.495C160.975 567.785 160.269 569.116 159.379 570.29C158.498 571.464 157.48 572.464 156.325 573.287C155.17 574.102 153.924 574.722 152.589 575.148C151.254 575.574 149.867 575.787 148.427 575.787C145.908 575.787 143.763 575.172 141.993 573.941C140.231 572.7 138.972 570.948 138.214 568.685C137.466 566.412 137.348 563.723 137.859 560.617C138.37 557.587 139.35 554.973 140.799 552.776C142.248 550.57 144.024 548.874 146.126 547.691C148.228 546.498 150.511 545.901 152.973 545.901C154.45 545.901 155.809 546.114 157.049 546.54C158.29 546.966 159.369 547.591 160.288 548.415C161.207 549.23 161.922 550.224 162.433 551.398C162.954 552.563 163.228 553.893 163.257 555.39ZM166.847 575.39H163.154L178.665 546.299H182.301L188.154 575.39H184.461L179.858 550.901H179.631L166.847 575.39ZM170.086 564.026H184.972L184.461 567.151H169.574L170.086 564.026Z"
                }
              />
            </>
          )}
          <Path
            d={
              "M293.363 779.955C293.363 779.955 292.519 772.457 294.437 770.162C296.355 767.866 301.724 761.363 301.724 754.859C301.724 748.356 295.971 750.269 294.437 744.148C292.903 738.027 306.326 723.108 297.505 705.893C288.685 688.678 267.975 703.215 260.305 698.242C252.634 693.268 232.308 700.154 234.993 693.268C237.678 686.382 232.457 671.13 229.624 664.194C226.79 657.259 237.678 658.074 237.678 651.953C237.678 645.832 237.678 605.281 237.678 605.281C235.687 583.667 228.09 555.549 216.968 552.489C205.846 549.428 198.176 524.945 190.506 518.059C182.836 511.173 166.805 496.787 164.366 485.409C164.366 485.409 161.069 474.318 160.302 465.902C159.536 457.486 162.893 448.817 154.072 443.844C145.252 438.871 127.61 427.394 125.309 410.944C123.008 394.494 121.474 384.931 117.639 379.575C113.804 374.219 104.6 375.749 100.381 376.514C96.1623 377.28 66.2487 355.091 64.7147 349.353C63.1807 343.615 67.3993 337.111 72.7684 332.138C78.1375 327.165 82.7397 326.4 85.8077 323.34C88.8758 320.279 93.8614 315.688 104.216 313.393C114.571 311.098 98.08 297.708 98.4635 286.614C98.8471 275.52 109.969 246.446 112.653 236.5C115.338 226.554 107.668 221.963 112.653 195.567C117.639 169.171 109.969 164.197 109.969 159.224C109.969 154.251 115.338 150.043 121.091 132.063C126.843 114.083 121.091 103.371 123.775 95.3378C126.46 87.3042 121.091 85.774 123.775 79.2706C126.46 72.7672 137.582 49.0489 132.979 39.4851C128.377 29.9213 143.234 17.4401 143.234 2.13794"
            }
            stroke="#D5D5D5"
            strokeWidth={9}
          />
          <AnimatedPath
            d={
              "M293.363 779.955C293.363 779.955 292.519 772.457 294.437 770.162C296.355 767.866 301.724 761.363 301.724 754.859C301.724 748.356 295.971 750.269 294.437 744.148C292.903 738.027 306.326 723.108 297.505 705.893C288.685 688.678 267.975 703.215 260.305 698.242C252.634 693.268 232.308 700.154 234.993 693.268C237.678 686.382 232.457 671.13 229.624 664.194C226.79 657.259 237.678 658.074 237.678 651.953C237.678 645.832 237.678 605.281 237.678 605.281C235.687 583.667 228.09 555.549 216.968 552.489C205.846 549.428 198.176 524.945 190.506 518.059C182.836 511.173 166.805 496.787 164.366 485.409C164.366 485.409 161.069 474.318 160.302 465.902C159.536 457.486 162.893 448.817 154.072 443.844C145.252 438.871 127.61 427.394 125.309 410.944C123.008 394.494 121.474 384.931 117.639 379.575C113.804 374.219 104.6 375.749 100.381 376.514C96.1623 377.28 66.2487 355.091 64.7147 349.353C63.1807 343.615 67.3993 337.111 72.7684 332.138C78.1375 327.165 82.7397 326.4 85.8077 323.34C88.8758 320.279 93.8614 315.688 104.216 313.393C114.571 311.098 98.08 297.708 98.4635 286.614C98.8471 275.52 109.969 246.446 112.653 236.5C115.338 226.554 107.668 221.963 112.653 195.567C117.639 169.171 109.969 164.197 109.969 159.224C109.969 154.251 115.338 150.043 121.091 132.063C126.843 114.083 121.091 103.371 123.775 95.3378C126.46 87.3042 121.091 85.774 123.775 79.2706C126.46 72.7672 137.582 49.0489 132.979 39.4851C128.377 29.9213 143.234 17.4401 143.234 2.13794"
            }
            stroke="#FC5200"
            strokeWidth={9}
            fill="none"
            strokeDasharray={selectedHike?.pathLength}
            animatedProps={animatedProps}
          />
        </Svg>
      </View>
    </GestureWrapper>
  );
};

const styles = StyleSheet.create({
  container: { flexDirection: "row", alignItems: "center", gap: 10 },
  statsContainer: {
    display: "flex",
    alignItems: "center",
    width: 100,
  },
  label: {
    color: "white",
    marginTop: 10,
    fontSize: 10,
  },
  value: {
    fontSize: 12,
    color: "white",
    fontWeight: "bold",
  },

  percentage: {
    marginTop: 12,
    fontSize: 12,
    color: "white",
    fontWeight: "bold",
    textAlign: "center",
    fontStyle: "italic",
  },
});
